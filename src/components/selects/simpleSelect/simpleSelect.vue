<script setup>
/**
 * üìã Descri√ß√£o:
 * Um dropdown gen√©rico e acess√≠vel, com suporte a sele√ß√£o √∫nica ou m√∫ltipla,
 * fechamento autom√°tico ao clicar fora, busca, e personaliza√ß√£o de r√≥tulos.
 *
 * üí° Uso:
 * <SimpleSelect
 *   v-model="selectedOptions"
 *   :options="departments"
 *   placeholder="Selecione algo..."
 *   :multiple="true"
 * />
 */

import { ref, computed, defineProps, defineEmits } from "vue";
import { onClickOutside } from "@vueuse/core";

const props = defineProps({
  // --- Valor selecionado ‚Äî pode ser um √∫nico valor ou um array (caso m√∫ltiplo) ---

  modelValue: {
    type: [Array, String, Number, Object],
    default: () => [],
  },

  // --- Lista de op√ß√µes dispon√≠veis ---
  // ---  Cada item deve ter no m√≠nimo: { value: any, name: string } ---
  options: {
    type: Array,
    required: true,
    default: () => [],
  },

  // --- Texto exibido quando nada est√° selecionado ---
  placeholder: {
    type: String,
    default: "Selecione uma op√ß√£o...",
  },

  // --- Permite m√∫ltiplas sele√ß√µes ---
  multiple: {
    type: Boolean,
    default: false,
  },
  // --- Tema para customiza√ß√£o via CSS ---
  theme: {
    type: String,
    default: "bg-base-300 border-base-300",
  },
});

const emit = defineEmits(["update:modelValue"]);

const isOpen = ref(false);
const dropdownRef = ref(null);

// --- Fecha dropdown ao clicar fora ---
onClickOutside(dropdownRef, () => (isOpen.value = false));

// --- Verifica se um item est√° selecionado ---
const isSelected = (optionValue) => {
  if (props.multiple && Array.isArray(props.modelValue)) {
    return props.modelValue.includes(optionValue);
  }
  return props.modelValue === optionValue;
};

// --- Alterna sele√ß√£o (single ou m√∫ltipla) ---
const toggleSelect = (optionValue) => {
  if (props.multiple) {
    const selected = Array.isArray(props.modelValue)
      ? [...props.modelValue]
      : [];

    const index = selected.indexOf(optionValue);
    if (index === -1) selected.push(optionValue);
    else selected.splice(index, 1);

    emit("update:modelValue", selected);
  } else {
    emit("update:modelValue", optionValue);
    isOpen.value = false; // Fecha dropdown no modo single
  }
};

// --- Label exibido no campo principal ---
const displayLabel = computed(() => {
  if (props.multiple && Array.isArray(props.modelValue)) {
    if (props.modelValue.length === 0) return props.placeholder;
    const selectedNames = props.options
      .filter((opt) => props.modelValue.includes(opt.value))
      .map((opt) => opt.name);
    return selectedNames.join(", ");
  }

  const selectedOption = props.options.find(
    (opt) => opt.value === props.modelValue
  );
  return selectedOption?.name || props.placeholder;
});
</script>

<template>
  <div class="relative w-full" ref="dropdownRef">
    <!-- Campo principal -->
    <div
      @click="isOpen = !isOpen"
      :class="[
        'flex flex-wrap items-center justify-between gap-2 p-3 rounded-md border cursor-pointer transition',
        theme,
      ]"
    >
      <span
        :class="[
          'text-sm truncate max-w-full',
          displayLabel === placeholder ? 'text-gray-400' : 'text-white',
        ]"
      >
        {{ displayLabel }}
      </span>

      <!-- √çcone -->
      <svg
        :class="[
          'size-3.5 text-white transition-transform duration-300',
          isOpen ? 'rotate-180' : '',
        ]"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <path
          stroke="currentColor"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="m19 9-7 7-7-7"
        />
      </svg>
    </div>

    <!-- Dropdown -->
    <div
      v-if="isOpen"
      :class="[
        'absolute flex flex-col z-10 mt-1.5 w-full  shadow-sm border rounded-md max-h-64 overflow-y-auto hide-scrollbar',
        theme,
      ]"
    >
      <button
        v-for="option in options"
        :key="option.value"
        :class="[
          isSelected(option.value)
            ? 'bg-green-500/30 hover:bg-green-500/50'
            : 'hover:bg-base-200',
          'flex items-center justify-between gap-2 px-3 py-2 text-left text-sm cursor-pointer transition w-full',
        ]"
        @click="toggleSelect(option.value)"
      >
        <span>{{ option.name }}</span>

        <!-- Indicador de sele√ß√£o -->
        <svg
          v-if="isSelected(option.value)"
          xmlns="http://www.w3.org/2000/svg"
          class="size-4 text-green-400"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"
          />
        </svg>
      </button>
    </div>
  </div>
</template>

<style scoped>
/* --- Esconde a barra de rolagem mantendo a rolagem funcional --- */
.hide-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.hide-scrollbar::-webkit-scrollbar {
  display: none;
}
</style>
